# Network Rule: Proxy Authentication Failure
# This is an example rule for the Phase 2 rule engine

id: NET-001
title: "Proxy Authentication Required"
severity: high
category: network
version: 1.0
author: "Autopilot Monitor Team"
description: |
  Detects when a device is behind a proxy that requires authentication,
  but the SYSTEM account (used during Autopilot enrollment) cannot authenticate.
  This is one of the most common causes of enrollment failures in enterprise networks.

conditions:
  # Primary signal: HTTP 407 errors from WinHTTP
  - signal: "event_407_detected"
    source: "windows_events"
    provider: "Microsoft-Windows-WinHttp"
    event_id: 407
    minimum_occurrences: 1

  # Supporting signal: Proxy is configured
  - signal: "winhttp_proxy_configured"
    source: "registry"
    path: "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings"
    value: "ProxyEnable"
    expected: 1

  # Supporting signal: Enrollment stalled at MDM phase
  - signal: "enrollment_stalled_at_mdm"
    source: "phase_tracking"
    phase: "MdmEnrollment"
    duration_exceeds_seconds: 300

evidence_selectors:
  # Collect relevant log lines from IME log
  - type: "log_lines"
    source: "ime_log"
    pattern: "proxy|407|authentication|ProxyAuthenticationRequired"
    context_lines: 3
    max_lines: 20

  # Collect proxy configuration from registry
  - type: "registry_value"
    path: "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings"
    values:
      - "ProxyServer"
      - "ProxyEnable"
      - "ProxyOverride"

  # Collect WinHTTP events
  - type: "windows_event"
    provider: "Microsoft-Windows-WinHttp"
    event_ids: [407, 12029, 12032]
    max_events: 10

explanation: |
  The device is configured to use a proxy server that requires authentication.
  During Autopilot enrollment, many operations run under the SYSTEM account,
  which cannot provide user credentials to authenticate with the proxy.

  This causes connections to Microsoft Intune endpoints to fail, resulting in
  enrollment timeouts or failures.

  Common indicators:
  - HTTP 407 (Proxy Authentication Required) errors in logs
  - Enrollment stalls at the MDM Enrollment phase
  - WinHTTP errors about proxy authentication

remediation:
  - title: "Configure proxy bypass"
    steps:
      - "Add *.manage.microsoft.com to proxy bypass list"
      - "Add *.microsoftonline.com to proxy bypass list"
      - "Add enterpriseregistration.windows.net to bypass list"

  - title: "Use PAC file"
    steps:
      - "Create/update PAC file to bypass proxy for Microsoft endpoints"
      - "Deploy via GPO or Intune"

  - title: "Use authenticated proxy with certificate"
    steps:
      - "Configure proxy to trust device certificates"
      - "Use certificate-based authentication instead of user credentials"

related_docs:
  - url: "https://learn.microsoft.com/en-us/mem/intune/enrollment/windows-enrollment-network-requirements"
    title: "Intune network requirements"
  - url: "https://learn.microsoft.com/en-us/mem/autopilot/networking-requirements"
    title: "Autopilot networking requirements"

confidence_scoring:
  # Base confidence if just HTTP 407 is detected
  base: 50

  # Additional confidence based on other signals
  factors:
    # Proxy is actually configured (not direct connection)
    - signal: "winhttp_proxy_configured"
      weight: 20

    # Enrollment is actually stalled (not just slow)
    - signal: "enrollment_stalled_at_mdm"
      weight: 30

    # Multiple 407 errors (not just one transient issue)
    - signal: "multiple_407_errors"
      condition: "count >= 5"
      weight: 10

tags:
  - network
  - proxy
  - authentication
  - common
  - mdm-enrollment

# Test data (for validation)
test_cases:
  - name: "Proxy auth with bypass configured"
    expected: false
    evidence:
      - event_407_detected: false
      - winhttp_proxy_configured: true

  - name: "Direct connection with 407"
    expected: false
    evidence:
      - event_407_detected: true
      - winhttp_proxy_configured: false

  - name: "Classic proxy auth failure"
    expected: true
    evidence:
      - event_407_detected: true
      - winhttp_proxy_configured: true
      - enrollment_stalled_at_mdm: true
