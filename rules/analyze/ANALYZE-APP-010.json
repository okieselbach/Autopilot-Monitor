{
  "$schema": "../schema/analyze-rule.schema.json",
  "ruleId": "ANALYZE-APP-010",
  "title": "App Reverted to Error After Successful Install",
  "description": "Detects when a specific app (matched by appId) was first reported as successfully installed but subsequently reported an IME enforcement error — while enrollment completed successfully. The app may be broken post-enrollment.",
  "severity": "warning",
  "category": "apps",
  "enabled": true,
  "trigger": "correlation",
  "baseConfidence": 75,
  "conditions": [
    {
      "signal": "app_regression",
      "source": "event_correlation",
      "eventType": "app_install_completed",
      "correlateEventType": "app_install_failed",
      "joinField": "appId",
      "dataField": "errorPatternId",
      "operator": "equals",
      "value": "IME-ERROR-REPORT",
      "required": true
    },
    {
      "signal": "enrollment_succeeded",
      "source": "event_type",
      "eventType": "enrollment_complete",
      "operator": "exists",
      "value": "",
      "required": true
    }
  ],
  "confidenceThreshold": 70,
  "explanation": "An app was initially reported as **successfully installed** (`app_install_completed`) but the IME (Intune Management Extension) subsequently reported an **Error** state for the same app via an `IME-ERROR-REPORT` event — while the overall enrollment completed successfully.\n\nThis pattern occurs when the IME re-evaluates enforcement state after the initial install report and detects a failure, e.g. `EnforcementState` transitions from `Success` → `Error`. The affected app and its details are captured in the matched evidence.\n\nCommon causes:\n- A post-install detection check fails (detection rule mismatch)\n- The enforcement error code `-2016345060` (0x87D13B9C) indicates the app state diverged from expected\n- The app may appear installed in the ESP summary but is in an error state on the device\n\n**The enrollment succeeded, but the affected app requires attention.**",
  "remediation": [
    {
      "title": "Investigate the app's post-install enforcement state",
      "steps": [
        "Note the appId and appName from the rule finding — these identify the exact affected app",
        "Check the Intune portal: Devices > [Device] > Apps — confirm the current enforcement state of the app",
        "Review IME logs on the device: C:\\ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\\IntuneManagementExtension.log",
        "Search the log for the appId and look for 'EnforcementState' transitions (Success → Error) near the enrollment time",
        "Error -2016345060 (0x87D13B9C) typically indicates a detection failure after install — verify the app's detection rule in Intune",
        "Trigger a manual sync (Company Portal or Settings > Accounts > Access work or school > Sync) to force re-evaluation"
      ]
    },
    {
      "title": "Fix detection or installation issues",
      "steps": [
        "If detection fails: correct the detection rule (file path, registry key, or PowerShell script) in the Intune app configuration",
        "If the app itself is broken: redeploy or reassign the app to trigger a fresh install",
        "Consider adding a post-install validation script to catch this scenario proactively"
      ]
    }
  ],
  "relatedDocs": [
    { "title": "Troubleshoot Win32 app installations", "url": "https://learn.microsoft.com/en-us/troubleshoot/mem/intune/app-management/troubleshoot-win32-app-install" },
    { "title": "Intune Management Extension logs", "url": "https://learn.microsoft.com/en-us/mem/intune/apps/intune-management-extension" }
  ],
  "tags": ["apps", "win32", "enforcement", "post-install", "correlation"]
}
